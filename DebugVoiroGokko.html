<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <!--<link rel="stylesheet" href="css/base.css" />-->
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="https://code.createjs.com/1.0.0/createjs.min.js"></script>
    <script src="VoiroGokko.js"></script>
    <script src="Canvases.js"></script>
    <script>

        var canvases = new Canvases;
        var user_id = "123456789";
        var stage_dic = {};



        function init() {

            var startTime = Math.floor(new Date().getTime() / 1000);
            var node_list = document.querySelectorAll('#UserCanvasWrapper canvas');


            var CommentTimer = setInterval(CommentFunc, 500);

            function CommentFunc() {
                if (true) {
                    //XML読み込み
                    $(function () {
                        parse();
                        $("#select_game").change(function () {
                            var result = $(this).val();
                            parse(result);
                        });
                    });
                    function parse(type) {
                        $.ajax({
                            url: 'http://localhost/ignore/dummycommentlog.xml',
                            type: 'GET',
                            dataType: 'xml',
                            cache: false,
                            timeout: 5000,
                            success: function (xml) {
                                xml = xml.getElementsByTagName('chat');
                                for (var i = 0; i < xml.length; i++) {
                                    if ((startTime < xml[i].getAttributeNode("date").value) ||
                                        ((startTime == xml[i].getAttributeNode("date").value) && (startNo < xml[i].getAttributeNode("no").value))) {
                                        startTime = xml[i].getAttributeNode("date").value;
                                        startNo = xml[i].getAttributeNode("no").value;
                                        var user_id = xml[i].getAttributeNode("user_id").value;
                                        console.log(user_id);
                                        var comment = "";
                                        comment = xml[i].firstChild.nodeValue;
                                        console.log(comment);
                                        //ニコ生のコメントからコマンドを取得
                                        var baseCommandStart = comment.indexOf("[");
                                        var baseCommandEnd = comment.indexOf("]");
                                        if ((baseCommandStart != -1) && (baseCommandEnd != -1)) {
                                            if (baseCommandEnd - baseCommandStart - 1 > 0) {
                                                var command = comment.substr(baseCommandStart + 1, baseCommandEnd - baseCommandStart - 1);
                                                if (command) {
                                                    if (command == "delete") {
                                                        var target_canvas = document.getElementById(user_id);
                                                        target_canvas.remove()
                                                    }
                                                    else if (!document.getElementById(user_id)) {
                                                        var canvas_count = document.getElementById("UserCanvasWrapper").children.length;
                                                        console.log(canvas_count);
                                                        if (canvas_count < 6) {
                                                            var new_canvas = canvases.Create(user_id, canvas_count);
                                                            document.getElementById("UserCanvasWrapper").appendChild(new_canvas);
                                                            stage_dic[user_id] = new createjs.Stage(new_canvas);
                                                            var _tachieLoader = new TachieLoader(command);
                                                            stage_dic[user_id].addChild(_tachieLoader.getSkinImage());
                                                            createjs.Ticker.on("tick", function () {
                                                                stage_dic[user_id].update();
                                                                console.log("tick");
                                                            })
                                                        }
                                                    }
                                                    else {
                                                        var target_canvas = document.getElementById(user_id);
                                                        stage_dic[user_id].removeChildAt(0);
                                                        target_canvas.width = 1920;
                                                        target_canvas.height = 1080;
                                                        stage_dic[user_id] = new createjs.Stage(target_canvas);
                                                        var _tachieLoader = new TachieLoader(command);
                                                        stage_dic[user_id].addChild(_tachieLoader.getSkinImage());
                                                        //初回呼び出し時のtickerでupdateしておけば二度目はいらない？のでコメント化
                                                        //createjs.Ticker.on("tick", function () {
                                                        //    stage_dic[user_id].update();
                                                        //})
                                                    }
                                                }




                                                //if (command) {
                                                //    if (command == "delete") {
                                                //        var target_canvas = canvas_dic[user_id];
                                                //        canvas_dic[user_id].width = 0;
                                                //        canvas_dic[user_id].height = 0;
                                                //    }
                                                //    else if (!canvas_dic[user_id]) {
                                                //        aaaaaaaaaaaaaaaa += 200;
                                                //        console.log("#############L220");
                                                //        var add_canvas = document.createElement("canvas");
                                                //        add_canvas.id = user_id;
                                                //        add_canvas.width = 1920;
                                                //        add_canvas.height = 1080;
                                                //        var user_canvas = document.body.appendChild(add_canvas);
                                                //        canvas_dic[user_id] = user_canvas;
                                                //        user_canvas.style.position = "absolute";
                                                //        var left = 0;
                                                //        var top = 0;
                                                //        //別idの人からのコマンドで画像位置変更
                                                //        if (true) {
                                                //            left += aaaaaaaaaaaaaaaa;
                                                //        }
                                                //        user_canvas.style.left = (String(left) + "px");
                                                //        user_canvas.style.top = (String(top) + "px");
                                                //        stage_dic[user_id] = new createjs.Stage(user_id);
                                                //        console.log(canvas_dic);
                                                //        console.log(stage_dic[user_id]);
                                                //        var CGen = new Tachie(command);
                                                //        obj[CommentNow] = CGen;
                                                //        obj[CommentNow].y = HcgFormat['SkinHeight'] * (HcgFormat['CommentMax'] - 1);
                                                //        stage_dic[user_id].addChild(obj[CommentNow].getSkinImage());
                                                //        createjs.Ticker.on("tick", function () {
                                                //            stage_dic[user_id].update();
                                                //        });
                                                //        console.log(stage_dic[user_id]);
                                                //        if (command.indexOf("aoi") != -1) {
                                                //        }
                                                //    }
                                                //    else {
                                                //        stage_dic[user_id].removeChildAt(0);
                                                //        canvas_dic[user_id].width = 1920;
                                                //        canvas_dic[user_id].height = 1080;
                                                //        var CGen = new Tachie(command);
                                                //        obj[CommentNow] = CGen;
                                                //        obj[CommentNow].y = HcgFormat['SkinHeight'] * (HcgFormat['CommentMax'] - 1);
                                                //        stage_dic[user_id].addChild(obj[CommentNow].getSkinImage());
                                                //        createjs.Ticker.on("tick", function () {
                                                //            stage_dic[user_id].update();
                                                //        });
                                                //    }
                                                //}
                                                //stage.addChild(obj[CommentNow].getBGColorBar());
                                                //stage.addChild(obj[CommentNow].getEdgeCommentText());
                                                //stage.addChild(obj[CommentNow].getCommentText());
                                                //for (var i = CommentNow; i > (CommentNow - (HcgFormat['CommentMax'] - 1)); i--) {
                                                //    if ((i - 1) >= 0) {
                                                //        obj[(i - 1)].getSkinImage().y -= HcgFormat['SkinHeight'];
                                                //        //obj[(i - 1)].getBGColorBar().y -= HcgFormat['SkinHeight'];
                                                //        //obj[(i - 1)].getEdgeCommentText().y -= HcgFormat['SkinHeight'];
                                                //        //obj[(i - 1)].getCommentText().y -= HcgFormat['SkinHeight'];
                                                //    }
                                                //}

                                                //if ((CommentNow - HcgFormat['CommentMax']) >= 0) {
                                                //    stage.removeChild(obj[(CommentNow - HcgFormat['CommentMax'])].getSkinImage());
                                                //    //stage.removeChild(obj[(CommentNow - HcgFormat['CommentMax'])].getBGColorBar());
                                                //    //stage.removeChild(obj[(CommentNow - HcgFormat['CommentMax'])].getEdgeCommentText());
                                                //    //stage.removeChild(obj[(CommentNow - HcgFormat['CommentMax'])].getCommentText());
                                                //    delete obj[(CommentNow - HcgFormat['CommentMax'])];
                                                //}
                                            }
                                        }
                                        //CommentNow++;
                                        //var SlashComment = TxtFormat['SlashCommentVisible'];
                                        //var BSPComment = TxtFormat['BSPCommentVisible'];
                                        //var OwnerComment = TxtFormat['OwnerCommentVisible'];
                                        //if (isComment(xml[i].firstChild.nodeValue, SlashComment, BSPComment)) {
                                        //    if (OwnerComment == 1 || ((OwnerComment == 0) && (xml[i].getAttributeNode("owner").value != 1))) {
                                        //    }
                                        //}
                                        break;
                                    }
                                }
                            },
                            error: function () {
                                alert("commentlog.xmlロード失敗");
                            }
                        });
                    }
                }
            }
            window.addEventListener("load", init);


            //var node_list = document.querySelectorAll('#UserCanvasWrapper canvas');
            //console.log(node_list);
        }

    </script>
</head>
<body onload="init();">
    <div id="UserCanvasWrapper">
    </div>
    <div id="another">
        <canvas id="otherCanvas5" width="50" height="0"></canvas>
    </div>
</body>
</html>