<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <!--<link rel="stylesheet" href="css/base.css" />-->
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="https://code.createjs.com/1.0.0/createjs.min.js"></script>
    <script src="VoiroGokko.js"></script>
    <script>
        var SettingLoaded = true;
        var startTime = Math.floor(new Date().getTime() / 1000);
        
        function init() {

            
            var stage = new createjs.Stage("myCanvas");
            //var bmp = new createjs.Bitmap("imgs/akane.png");
            //if (bmp == null) {
            //    console.log("bmp is null");
            //}
            //stage.addChild(bmp);

            var CommentTimer = setInterval(CommentFunc, 500);
            var HcgFormat = {};
            var TxtFormat = new Object();
            /************************************************/
            //createjs.Ticker.setFPS(30);
            HcgFormat.CommentMax = 3;	//コメントの最大表示数 ここを4以上にしたらcanvasのheight値も変えること
            HcgFormat.SkinHeight = 32;	//使用するスキンの高さ
            var DemoMode = 0;	//デモモード
            /************************************************/
            var obj = [];
            var canvas_dic = [];
            var stage_dic = [];
            var aaaaaaaaaaaaaaaa = 0;
            var startTime = Math.floor(new Date().getTime() / 1000);
            var startNo = -1;
            var CommentNow = 0;
            var SettingLoaded = false;
            var FullPath = location.href;
            var PathArray = FullPath.split('/');
            var PathHead = "";
            if (PathArray[2] == "absolute") {
                PathHead = "http://absolute/";
            } else {
                PathHead = "";
            }
            HcgFormat.PathHead = PathHead;
            var CurrentPath = "";
            for (var i = 0; i < PathArray.length - 1; i++) {
                CurrentPath += PathArray[i] + "/";
            }
            HcgFormat.CurrentPath = CurrentPath;

            createjs.Ticker.addEventListener('tick', mainLoop);
            function mainLoop() {
                console.log("tick");
                //stage.update();
            }



            SettingFunc();
            var SettingTimer = setInterval(SettingFunc, 5000);
            if (DemoMode) {
                console.log("デモモード");
                var DemoTimer = setInterval(DemoFunc, 5000);
            } else {
                console.log("HTML5コメントジェネレーター");
                var CommentTimer = setInterval(CommentFunc, 500);
            }


            function isComment(comment, Slash, BSP) {
                if (comment.substring(0, 11) == "/press show") {
                    //ニコ生のBSP
                    if (BSP == 1) {
                        return true;
                    } else {
                        return false;
                    }
                } else if (comment.substring(0, 1) == "/") {
                    // "/"から始まるコメント
                    if (Slash == 1) {
                        return true;
                    } else {
                        return false;
                    }
                }
                return true;
            }


            function SettingFunc() {
                //XML読み込み
                $(function () {
                    parse();

                    $("#select_game").change(function () {
                        var result = $(this).val();
                        parse(result);
                    });
                });
                function parse(type) {
                    $.ajax({
                        url: 'http://localhost/ignore/setting.xml',
                        type: 'GET',
                        dataType: 'xml',
                        cache: false,
                        timeout: 5000,
                        success: function (xml) {
                            var skinfile = "";
                            var skinfolder = "";
                            if (xml.getElementsByTagName('SkinFile')[0].firstChild != null) {
                                skinfile = xml.getElementsByTagName('SkinFile')[0].firstChild.nodeValue;
                            }
                            if (xml.getElementsByTagName('SkinFolder')[0].firstChild != null) {
                                skinfolder = xml.getElementsByTagName('SkinFolder')[0].firstChild.nodeValue;
                            }
                            var txtFormat = {
                                'HandleVisible': xml.getElementsByTagName('HandleVisible')[0].firstChild.nodeValue,
                                'HandleOrder': xml.getElementsByTagName('HandleOrder')[0].firstChild.nodeValue,
                                'Honorific': xml.getElementsByTagName('Honorific')[0].firstChild.nodeValue,
                                'NoHandleType': xml.getElementsByTagName('NoHandleType')[0].firstChild.nodeValue,
                                'NoHandleName': xml.getElementsByTagName('NoHandleName')[0].firstChild.nodeValue,
                                'TxtColor': xml.getElementsByTagName('TxtColor')[0].firstChild.nodeValue,
                                'TxtFont': xml.getElementsByTagName('TxtFont')[0].firstChild.nodeValue,
                                'TxtSize': xml.getElementsByTagName('TxtSize')[0].firstChild.nodeValue,
                                'BgColor': xml.getElementsByTagName('BgColor')[0].firstChild.nodeValue,
                                'BgColorType': xml.getElementsByTagName('BgColorType')[0].firstChild.nodeValue,
                                'TxtEdgeColor': xml.getElementsByTagName('TxtEdgeColor')[0].firstChild.nodeValue,
                                'TxtEdgeType': xml.getElementsByTagName('TxtEdgeType')[0].firstChild.nodeValue,
                                'TxtEdgeValue': xml.getElementsByTagName('TxtEdgeValue')[0].firstChild.nodeValue,
                                'SkinType': xml.getElementsByTagName('SkinType')[0].firstChild.nodeValue,
                                'SkinFile': skinfile,
                                'SkinFolder': skinfolder,
                                'TimeType': xml.getElementsByTagName('TimeType')[0].firstChild.nodeValue,
                                'TimeValue': xml.getElementsByTagName('TimeValue')[0].firstChild.nodeValue,
                                'TxtUpSpace': xml.getElementsByTagName('TxtUpSpace')[0].firstChild.nodeValue,
                                'TxtLeftSpace': xml.getElementsByTagName('TxtLeftSpace')[0].firstChild.nodeValue,
                                'TxtLength': xml.getElementsByTagName('TxtLength')[0].firstChild.nodeValue,
                                'TxtLengthValue': xml.getElementsByTagName('TxtLengthValue')[0].firstChild.nodeValue,
                                'OwnerCommentVisible': xml.getElementsByTagName('OwnerCommentVisible')[0].firstChild.nodeValue,
                                'SlashCommentVisible': xml.getElementsByTagName('SlashCommentVisible')[0].firstChild.nodeValue,
                                'BSPCommentVisible': xml.getElementsByTagName('BSPCommentVisible')[0].firstChild.nodeValue,
                                'Direction': xml.getElementsByTagName('Direction')[0].firstChild.nodeValue,
                                'userBGColor': xml.getElementsByTagName('userBGColor')[0].firstChild.nodeValue,
                                'userSkinName': xml.getElementsByTagName('userSkinName')[0].firstChild.nodeValue
                            };
                            setTxtFormat(txtFormat);
                        },
                        error: function () {
                            alert("setting.xmlロード失敗");
                        }
                    });
                }
            }


            function CommentFunc() {
                if (SettingLoaded) {
                    //XML読み込み
                    $(function () {
                        parse();
                        $("#select_game").change(function () {
                            var result = $(this).val();
                            parse(result);
                        });
                    });
                    function parse(type) {
                        $.ajax({
                            url: 'http://localhost/ignore/commentlog.xml',
                            type: 'GET',
                            dataType: 'xml',
                            cache: false,
                            timeout: 5000,
                            success: function (xml) {
                                xml = xml.getElementsByTagName('chat');
                                for (var i = 0; i < xml.length; i++) {
                                    if ((startTime < xml[i].getAttributeNode("date").value) ||
                                        ((startTime == xml[i].getAttributeNode("date").value) && (startNo < xml[i].getAttributeNode("no").value))) {
                                        startTime = xml[i].getAttributeNode("date").value;
                                        startNo = xml[i].getAttributeNode("no").value;
                                        var user_id = xml[i].getAttributeNode("user_id").value;
                                        console.log(user_id);
                                        var SlashComment = TxtFormat['SlashCommentVisible'];
                                        var BSPComment = TxtFormat['BSPCommentVisible'];
                                        var OwnerComment = TxtFormat['OwnerCommentVisible'];
                                        if (isComment(xml[i].firstChild.nodeValue, SlashComment, BSPComment)) {
                                            if (OwnerComment == 1 || ((OwnerComment == 0) && (xml[i].getAttributeNode("owner").value != 1))) {
                                                //var handle = "";
                                                //if (xml[i].getAttributeNode("handle") != null) {
                                                //    handle = xml[i].getAttributeNode("handle").value;
                                                //} else {
                                                //    if (xml[i].getAttributeNode("no") != null) {
                                                //        if (TxtFormat['NoHandleType'] == 0) {
                                                //            handle = xml[i].getAttributeNode("no").value + "コメ";
                                                //        } else if (TxtFormat['NoHandleType'] == 1) {
                                                //            handle = TxtFormat['NoHandleName'];
                                                //        }
                                                //    }
                                                //}
                                                var comment = "";
                                                comment = xml[i].firstChild.nodeValue;
                                                console.log(comment);
                                                var baseCommandStart = comment.indexOf("[");
                                                var baseCommandEnd = comment.indexOf("]");
                                                var faceCommandStart = fixComment(xml[i].firstChild.nodeValue).indexOf("[");
                                                var faceCmmandEnd = fixComment(xml[i].firstChild.nodeValue).indexOf("]");
                                                if ((baseCommandStart != -1) && (baseCommandEnd != -1)) {
                                                    if (baseCommandEnd - baseCommandStart - 1 > 0) {
                                                        //PrivateSkin = TxtFormat['SkinFolder'] + "/skin_" + Handle.substr(PrivateSkinStart + 1, PrivateSkinEnd - PrivateSkinStart - 1) + ".png";
                                                        var command = comment.substr(baseCommandStart + 1, baseCommandEnd - baseCommandStart - 1);
                                                        //新規キャンバス作成
                                                        //1user:1canvasの方針に変更
                                                        if (command) {
                                                            if (command == "delete") {
                                                                var target_canvas = canvas_dic[user_id];
                                                                canvas_dic[user_id].width = 0;
                                                                canvas_dic[user_id].height = 0;
                                                            }
                                                            else if (!canvas_dic[user_id]) {
                                                                aaaaaaaaaaaaaaaa += 200;
                                                                console.log("#############L220");
                                                                var add_canvas = document.createElement("canvas");
                                                                add_canvas.id = user_id;
                                                                add_canvas.width = 1920;
                                                                add_canvas.height = 1080;
                                                                var user_canvas = document.body.appendChild(add_canvas);
                                                                canvas_dic[user_id] = user_canvas;
                                                                user_canvas.style.position = "absolute";
                                                                var left = 0;
                                                                var top = 0;
                                                                //別idの人からのコマンドで画像位置変更
                                                                if (true) {
                                                                    left += aaaaaaaaaaaaaaaa;
                                                                }
                                                                user_canvas.style.left = (String(left) + "px");
                                                                user_canvas.style.top = (String(top) + "px");
                                                                stage_dic[user_id] = new createjs.Stage(user_id);
                                                                console.log(canvas_dic);
                                                                console.log(stage_dic[user_id]);
                                                                var CGen = new Tachie(command);
                                                                obj[CommentNow] = CGen;
                                                                obj[CommentNow].y = HcgFormat['SkinHeight'] * (HcgFormat['CommentMax'] - 1);
                                                                stage_dic[user_id].addChild(obj[CommentNow].getSkinImage());
                                                                createjs.Ticker.on("tick", function () {
                                                                    stage_dic[user_id].update();
                                                                });
                                                                console.log(stage_dic[user_id]);
                                                                if (command.indexOf("aoi") != -1) {
                                                                }
                                                            }
                                                            else {
                                                                stage_dic[user_id].removeChildAt(0);
                                                                canvas_dic[user_id].width = 1920;
                                                                canvas_dic[user_id].height = 1080;
                                                                var CGen = new Tachie(command);
                                                                obj[CommentNow] = CGen;
                                                                obj[CommentNow].y = HcgFormat['SkinHeight'] * (HcgFormat['CommentMax'] - 1);
                                                                stage_dic[user_id].addChild(obj[CommentNow].getSkinImage());
                                                                createjs.Ticker.on("tick", function () {
                                                                    stage_dic[user_id].update();
                                                                });
                                                            }
                                                        }
                                                        //stage.addChild(obj[CommentNow].getBGColorBar());
                                                        //stage.addChild(obj[CommentNow].getEdgeCommentText());
                                                        //stage.addChild(obj[CommentNow].getCommentText());
                                                        //for (var i = CommentNow; i > (CommentNow - (HcgFormat['CommentMax'] - 1)); i--) {
                                                        //    if ((i - 1) >= 0) {
                                                        //        obj[(i - 1)].getSkinImage().y -= HcgFormat['SkinHeight'];
                                                        //        //obj[(i - 1)].getBGColorBar().y -= HcgFormat['SkinHeight'];
                                                        //        //obj[(i - 1)].getEdgeCommentText().y -= HcgFormat['SkinHeight'];
                                                        //        //obj[(i - 1)].getCommentText().y -= HcgFormat['SkinHeight'];
                                                        //    }
                                                        //}

                                                        //if ((CommentNow - HcgFormat['CommentMax']) >= 0) {
                                                        //    stage.removeChild(obj[(CommentNow - HcgFormat['CommentMax'])].getSkinImage());
                                                        //    //stage.removeChild(obj[(CommentNow - HcgFormat['CommentMax'])].getBGColorBar());
                                                        //    //stage.removeChild(obj[(CommentNow - HcgFormat['CommentMax'])].getEdgeCommentText());
                                                        //    //stage.removeChild(obj[(CommentNow - HcgFormat['CommentMax'])].getCommentText());
                                                        //    delete obj[(CommentNow - HcgFormat['CommentMax'])];
                                                        //}
                                                    }
                                                }
                                                CommentNow++;
                                            }
                                        }
                                        break;
                                    }
                                }
                            },
                            error: function () {
                                alert("commentlog.xmlロード失敗");
                            }
                        });
                    }
                }
            }
            window.addEventListener("load", init);


            function setTxtFormat(txtFormat) {
                console.log("設定を読み込みました");
                TxtFormat = txtFormat;
                SettingLoaded = true;
            }


            //コメント処理
            function fixComment(comment) {
                if (comment.substring(0, 11) == "/press show") {
                    //BSPコメント
                    var bsp_array = comment.split(" ");
                    var bsp = "";
                    for (var i = 3; i < bsp_array.length; i++) {
                        bsp += bsp_array[i] + " ";
                    }
                    comment = bsp;
                } else if (comment.substring(0, 5) == "/perm") {
                    //運営コメント(perm)
                    var perm_array = comment.split(" ");
                    var perm = "";
                    for (var i = 1; i < perm_array.length; i++) {
                        perm += perm_array[i] + " ";
                    }
                    comment = perm;
                } else if (comment.substring(0, 1) == "/") {
                    //運営コメント
                    comment = comment.substr(1);
                }
                //<>を元に戻す
                comment = comment.replace(/&amp;/g, "&");
                comment = comment.replace(/&lt;/g, "<");
                comment = comment.replace(/&gt;/g, ">");

                //htmlタグ除去
                var pattern = /<("[^"]*"|'[^']*'|[^'">])*>/g;
                comment = comment.replace(pattern, '');

                return comment.trim();
            }


            createjs.Ticker.on("tick", function () {
                stage.update();
            });
        }
    </script>
</head>
<body onload="init();">
    <canvas id="myCanvas" width="0" height="0"></canvas>
</body>
</html>